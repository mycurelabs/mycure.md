# Javascript Node CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-javascript/ for more details
#
version: 2
jobs:
  dev:
    machine: true
    working_directory: ~/repo

    steps:
      - checkout

      - run:
          name: Publish MYCURE Main Website to Firebase
          command: |
            echo Install NVM
            curl https://raw.githubusercontent.com/creationix/nvm/v0.30.2/install.sh | bash
            source ~/.profile
            echo Install Node via NVM
            nvm install v10.16.0
            echo Install Yarn via NPM
            npm install yarn -g
            echo Install Dependencies
            yarn install
            yarn add firebase-tools -D
            echo Build WebApp
            yarn build
            echo Deploy to Firebase Hosting
            yarn deploy:dev -- --token=$FIREBASE_TOKEN
  prod:
    machine: true
    working_directory: ~/repo

    steps:
      - checkout

      - run:
          name: Publish MYCURE Main Website to Firebase
          command: |
            echo Install NVM
            curl https://raw.githubusercontent.com/creationix/nvm/v0.30.2/install.sh | bash
            source ~/.profile
            echo Install Node via NVM
            nvm install v10.16.0
            echo Install Yarn via NPM
            npm install yarn -g
            echo Install Dependencies
            yarn install
            yarn add firebase-tools -D
            echo Build WebApp
            yarn build
            echo Deploy to Firebase Hosting
            yarn deploy:prod -- --token=$FIREBASE_TOKEN
            
      # - run:
      #     name: Install Yarn
      #     command: |

      # - restore_cache:
      #     keys:
      #       - v1-dependencies-{{ checksum "package.json" }}
      #       # fallback to using the latest cache if no exact match is found
      #       - v1-dependencies-

      # - run: 
      #     name: Install Dependencies
      #     command: |
      #       nvm use v10.16.0

      # - save_cache:
      #     paths:
      #       - node_modules
      #     key: v1-dependencies-{{ checksum "package.json" }}

      # run build!
      # - run:
      #     name: Build WebApp
      #     command: yarn build
      
      # install firebase!
      # - run:
      #     name: Install Firebase CLI
      #     command: yarn add firebase-tools -D
      
      # run deploy!
      # - run:
      #     name: Deploy to Firebase
      #     command: yarn deploy -- --token=$FIREBASE_TOKEN

workflows:
  version: 2
  publish:
    jobs: 
      - dev:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
      - hold:
          type: approval
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
          requires: 
            - dev
      - prod:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
          requires: 
            - hold

